{% extends 'base.html' %}

{% block title %}
    Choose the Candidates
{% endblock %}

{% block content %}
<style>
    .modal-content {
        padding: 0;
    }

    .modal-body {
        padding: 15px;  /* Adjust as necessary */
        max-height: calc(100vh - 210px); /* You may need to adjust this value */
        overflow-y: auto; /* Allow scrolling inside modal body */
    }

    .submit-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
    }

    /* styles.css */
    .star-rating {
    direction: rtl;
    display: inline-block;
    padding: 0;
    margin: 0;
    }

    .star-rating input[type=radio] {
    display: none;
    }


    .star-rating label {
    color: #ddd;
    float: right;
    font-size: 30px;
    }

    .star-rating input[type=radio]:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label {
    color: #ffc107;
    }

    .star-rating input[type=radio]:checked + label:hover,
    .star-rating input[type=radio]:checked ~ label:hover,
    .star-rating label:hover ~ input[type=radio]:checked ~ label {
    color: #c09;
    }

</style>
<div class="container mt-5">
    <div class="progress mt-4">
        <div class="progress-bar" role="progressbar" 
            style="width: {{ progress|round(2) }}%;" 
            aria-valuenow="{{ progress|round(2) }}" 
            aria-valuemax="100">
            {{ progress|round(2) }}%
        </div>
    </div>

{% if similar_inquery_data %}
<button type="button" class="btn btn-info" data-toggle="modal" data-target="#preAnnotatedModal">
  Expert Annotated
</button>
{% endif %}



    <form action="{{ url_for('annotate', source=query.source) }}" method="POST">
      <div class="mb-3">
        <input type="hidden" name="query_id" value="{{ query.id }}">
        <label for="query" class="form-label">Privacy Requirement</label>
        <h2>#{{ query.id }}</h2>
        <h4>{{ query.text }}</h4>
        tags: 
        {% for tag in query.tags %}
        <a target="_blank" href="https://privacypatterns.org/categories/{{ tag.name }}/">{{ tag.name }}</a>{% if not loop.last %}, {% endif %}
        {% endfor %}
      </div>
  
      <table class="table table-striped table-hover">
          <thead>
              <tr>
                  <th>Privacy Design Pattern</th>
                  <th>Relevance</th>
              </tr>
          </thead>
          <tbody>
              {% for candidate in recommended_candidates %}
              <tr>
                  <td style="text-align: left; width: 60%;">
                    <h4>{{ candidate.candidate.text }}</h4>
                    <p>{{ candidate.candidate.description }}...<a href="{{ candidate.candidate.source }}" target="_blank">more</a></p> 
                    <br>
                    tags: 
                    {% for tag in candidate.candidate.tags %}
                    <a target="_blank" href="https://privacypatterns.org/categories/{{ tag.name }}/">{{ tag.name }}</a>{% if not loop.last %}, {% endif %}
                    {% endfor %}

                </td>
                  <td>
                      <div class="star-rating">
                          {% for i in range(5, 0, -1) %}
                          <input type="radio" id="{{ candidate.candidate.id }}-{{ i }}" name="{{ candidate.candidate.id }}" value="{{ i }}" {% if candidate.relevance == i %}checked{% endif %}><label for="{{ candidate.candidate.id }}-{{ i }}">☆</label>
                          {% endfor %}
                      </div>
                  </td>
              </tr>
              {% endfor %}


              {% for candidate in other_candidates %}
              <tr>
                  <td style="text-align: left; width: 60%;">
                    <h4>{{ candidate.text }}</h4>
                    <p>{{ candidate.description }}...<a href="{{ candidate.source }}" target="_blank">more</a></p> 
                    <br>
                    tags: 
                    {% for tag in candidate.tags %}
                    <a target="_blank" href="https://privacypatterns.org/categories/{{ tag.name }}/">{{ tag.name }}</a>{% if not loop.last %}, {% endif %}
                    {% endfor %}

                </td>
                  <td>
                      <div class="star-rating">
                          {% for i in range(5, 0, -1) %}
                          <input type="radio" id="{{ candidate.id }}-{{ i }}" name="{{ candidate.id }}" value="{{ i }}"><label for="{{ candidate.id }}-{{ i }}">☆</label>
                          {% endfor %}
                      </div>
                  </td>
              </tr>
              {% endfor %}
          </tbody>
      </table>
      <button type="submit" class="btn btn-primary submit-button">Submit</button>
      
    </form>
  </div>


  {% if similar_inquery_data %}
  <div class="modal" id="preAnnotatedModal">
      <div class="modal-dialog modal-lg"> <!-- Increase modal size with modal-lg -->
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">Pre-annotated Score Available</h5>
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>
              <div class="modal-body overflow-auto"> <!-- Add overflow auto -->
                      <h3>Semantically Similar Annotated Data</h3>
                      <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th scope="col" style="width: 2%;">#</th>
                                    <th scope="col" style="width: 30%;">Query</th>
                                    <th scope="col" style="width: 50%;">Candidate</th>
                                    <th scope="col" style="width: 5%;">Action</th>
                                </tr>
                            </thead>
                            
                            <tbody>
                                {% for data in similar_inquery_data %}
                                    <tr>
                                        <th scope="row">{{ data.id }}</th>
                                        <td>{{ data.query }} (<span class="label label-default">Score: {{ data.score }}</span>) <br><br>  <span class="label label-primary">{{ data.tags|join(', ') }}</span></td>
                                        <td>
                                            {% set sorted_candidates = data.candidates|sort(attribute='1', reverse=True) %}
                                            {% for candidate, relevance in sorted_candidates %}
                                            {{ candidate }} ({{ relevance }}){% if not loop.last %}, {% endif %}
                                            {% endfor %}
                                        </td>
                                        <td>
                                            <form action="{{ url_for('apply_annotation') }}" method="POST">
                                                <input type="hidden" name="previous_query_id" value="{{ data.id }}">
                                                <input type="hidden" name="current_query_id" value="{{ query.id }}">
                                                <input type="hidden" name="source" value="{{ query.source }}">
                                                <td><button type="submit" class="btn btn-sm btn-primary">Apply</button></td>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                            
                            
                        </table>
                        
                        
                    </div>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              </div>
          </div>
      </div>
  </div>
  
  
  {% endif %}
  

{% endblock %}
